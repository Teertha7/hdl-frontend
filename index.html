<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Verilog Personal Playground Pro</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>

    <style>
        /* ===== GLOBAL ===== */
        * { box-sizing: border-box; }
        body { margin: 0; height: 100vh; background: #1e1e1e; color: #e6e6e6; font-family: "Segoe UI", sans-serif; overflow: hidden; }

        /* ===== APP LAYOUT ===== */
        .app { display: flex; height: 100vh; }

        /* ===== SIDEBAR ===== */
        .sidebar { width: 220px; background: #181818; border-right: 1px solid #2a2a2a; padding: 12px 8px; }
        .sidebar-title { font-size: 11px; color: #8b949e; margin-bottom: 12px; padding-left: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .sidebar-item { padding: 10px 14px; margin-bottom: 6px; border-radius: 6px; cursor: pointer; color: #c9d1d9; font-size: 14px; transition: 0.2s; }
        .sidebar-item:hover { background: #262626; }
        .sidebar-item.active { background: #238636; color: white; font-weight: 600; }

        /* ===== WORKSPACE ===== */
        .workspace { flex: 1; display: flex; flex-direction: column; }
        .toolbar { height: 56px; background: #252526; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #3c3c3c; }
        
        /* ===== BUTTONS ===== */
        .run-btn { background: #2ea043; color: white; border: none; padding: 8px 22px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .run-btn:hover { background: #3fb950; }

        /* ===== EDITOR AREA ===== */
        .editor-area { flex: 1; display: flex; background: #1e1e1e; }
        .editor-container { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .editor-header { height: 35px; background: #2d2d2d; padding: 8px 15px; font-size: 12px; color: #aaa; border-bottom: 1px solid #3c3c3c; }
        .editor-instance { flex: 1; width: 100%; }

        /* ===== CONSOLE ===== */
        #console { height: 180px; background: #0c0c0c; color: #00ff88; padding: 12px; font-family: 'Consolas', monospace; border-top: 1px solid #333; overflow-y: auto; white-space: pre-wrap; font-size: 13px; }

        /* ===== WAVEFORM POPUP ===== */
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; }
        #popup { display: none; position: fixed; top: 8%; left: 5%; width: 90%; height: 80%; background: white; color: black; border-radius: 12px; padding: 20px; z-index: 101; overflow: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .close-btn { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>

<body onload="WaveDrom.ProcessAll()">

<div class="app">
    <div class="sidebar">
        <div class="sidebar-title">Digital Design</div>
        <div class="sidebar-item active" onclick="runSimulation()">â–¶ Run Simulation</div>
        <div class="sidebar-item" style="opacity: 0.5; cursor: not-allowed;">ðŸ§± Synthesis (Coming Soon)</div>
    </div>

    <div class="workspace">
        <div class="toolbar">
            <strong>Verilog Pro Playground</strong>
            <button class="run-btn" onclick="runSimulation()">Run Simulation</button>
        </div>

        <div class="editor-area">
            <div class="editor-container">
                <div class="editor-header">TESTBENCH.V</div>
                <div id="tb-editor" class="editor-instance"></div>
            </div>

            <div class="editor-container">
                <div class="editor-header">DESIGN.V</div>
                <div id="design-editor" class="editor-instance"></div>
            </div>
        </div>

        <div id="console">Ready for simulation...</div>
    </div>
</div>

<div id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button class="close-btn" onclick="closePopup()">Close Waveform</button>
    <div id="waveform-svg-container"></div>
</div>

<script>
    let tbEditor, designEditor;

    // 1. Initialize Monaco Editor
    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });
    require(['vs/editor/editor.main'], function () {
        const commonConfig = {
            theme: 'vs-dark',
            language: 'verilog',
            automaticLayout: true,
            fontSize: 14,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
            lineNumbers: "on"
        };
        
        // Default Testbench Code
        tbEditor = monaco.editor.create(document.getElementById('tb-editor'), {
            ...commonConfig,
            value: `module half_adder_tb;\n  reg a, b;\n  wire sum, carry;\n\n  half_adder uut (.a(a), .b(b), .sum(sum), .carry(carry));\n\n  initial begin\n    $dumpfile("dump.vcd");\n    $dumpvars(0, half_adder_tb);\n\n    a = 0; b = 0; #10;\n    a = 0; b = 1; #10;\n    a = 1; b = 0; #10;\n    a = 1; b = 1; #10;\n    $finish;\n  end\nendmodule`
        });

        // Default Design Code
        designEditor = monaco.editor.create(document.getElementById('design-editor'), {
            ...commonConfig,
            value: `module half_adder(input a, b, output sum, carry);\n  assign sum = a ^ b;\n  assign carry = a & b;\nendmodule`
        });
    });

    // 2. Run Simulation Logic
    async function runSimulation() {
        const consoleBox = document.getElementById('console');
        consoleBox.innerText = "Simulating...\n";

        try {
            // RESTORED: Your original functional Render URL
            const res = await fetch('https://hdl-backend-a39u.onrender.com/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    design: designEditor.getValue(),
                    testbench: tbEditor.getValue()
                })
            });
            
            const data = await res.json();
            consoleBox.innerText += data.log;

            if (data.vcd) {
                renderWaveform(data.vcd);
            } else {
                consoleBox.innerText += "\n[System]: No VCD data received.";
            }
        } catch (e) {
            consoleBox.innerText += "\nError connecting to server.";
            console.error(e);
        }
    }

    // 3. Robust VCD to WaveDrom Parser (Works with any VCD file)
    function renderWaveform(vcdText) {
        const lines = vcdText.split('\n');
        let signals = [];
        
        // Discover ALL signals (detects wire, reg, integer, etc.)
        lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed.startsWith('$var')) {
                const parts = trimmed.split(/\s+/);
                // parts[3] = identifier code, parts[4] = signal name
                signals.push({ id: parts[3], name: parts[4], wave: '' });
            }
        });

        if (signals.length === 0) {
            console.error("No signals found in VCD");
            return;
        }

        // Parse transitions
        lines.forEach(line => {
            const t = line.trim();
            if (t.startsWith('#')) {
                signals.forEach(s => s.wave += '.');
            } else {
                signals.forEach(s => {
                    if (t.endsWith(s.id)) {
                        const val = t.charAt(0);
                        if (s.wave.endsWith('.')) {
                            s.wave = s.wave.slice(0, -1) + val;
                        } else {
                            s.wave += val;
                        }
                    }
                });
            }
        });

        const waveJSON = {
            signal: signals.map(s => {
                let finalWave = s.wave;
                if (!/^[01xz]/.test(finalWave)) finalWave = 'x' + finalWave;
                return { name: s.name, wave: finalWave };
            })
        };

        // UI Display
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('popup').style.display = 'block';

        const container = document.getElementById('waveform-svg-container');
        container.innerHTML = ""; 

        const script = document.createElement('script');
        script.type = 'WaveDrom';
        script.text = JSON.stringify(waveJSON);
        container.appendChild(script);

        WaveDrom.ProcessAll();
    }

    function closePopup() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('popup').style.display = 'none';
    }
</script>

</body>
</html>
