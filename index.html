<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verilog Personal Playground Pro</title>

<!-- Monaco -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>

<!-- WaveDrom -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/wavedrom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.1.0/skins/default.js"></script>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    height: 100vh;
    background: #1e1e1e;
    color: #e6e6e6;
    font-family: "Segoe UI", sans-serif;
    overflow: hidden;
}

.app {
    display: flex;
    height: 100vh;
}

/* ===== SIDEBAR ===== */
.sidebar {
    width: 220px;
    background: #181818;
    border-right: 1px solid #2a2a2a;
    padding: 12px 8px;
}

.sidebar-title {
    font-size: 11px;
    color: #8b949e;
    margin-bottom: 12px;
    padding-left: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.sidebar-item {
    padding: 10px 14px;
    margin-bottom: 6px;
    border-radius: 6px;
    cursor: pointer;
    color: #c9d1d9;
    font-size: 14px;
}

.sidebar-item.active {
    background: #238636;
    color: white;
    font-weight: 600;
}

/* ===== WORKSPACE ===== */
.workspace {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.toolbar {
    height: 56px;
    background: #252526;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    border-bottom: 1px solid #3c3c3c;
}

.run-btn {
    background: #2ea043;
    color: white;
    border: none;
    padding: 8px 22px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
}

/* ===== EDITORS ===== */
.editor-area {
    flex: 1;
    display: flex;
}

.editor-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #333;
}

.editor-header {
    height: 35px;
    background: #2d2d2d;
    padding: 8px 15px;
    font-size: 12px;
    color: #aaa;
    border-bottom: 1px solid #3c3c3c;
}

.editor-instance {
    flex: 1;
}

/* ===== CONSOLE ===== */
#console {
    height: 180px;
    background: #0c0c0c;
    color: #00ff88;
    padding: 12px;
    font-family: Consolas, monospace;
    border-top: 1px solid #333;
    overflow-y: auto;
    white-space: pre-wrap;
}

/* ===== WAVEFORM POPUP ===== */
#overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100;
}

#popup {
    display: none;
    position: fixed;
    top: 8%;
    left: 5%;
    width: 90%;
    height: 80%;
    background: white;
    color: black;
    border-radius: 12px;
    padding: 20px;
    z-index: 101;
    overflow: hidden;
}

/* ===== WAVE TOOLBAR ===== */
#wave-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

#wave-toolbar button {
    background: #2d2d2d;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
}

#wave-toolbar button:hover {
    background: #444;
}

#zoom-level {
    margin-left: auto;
    font-size: 12px;
    color: #333;
}

/* ===== WAVE CONTAINER ===== */
#waveform-svg-container {
    position: relative;
    overflow: auto;
    height: calc(100% - 90px);
}

#wave-cursor {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: red;
    display: none;
    pointer-events: none;
}
</style>
</head>

<body onload="WaveDrom.ProcessAll()">

<div class="app">
    <div class="sidebar">
        <div class="sidebar-title">Digital Design</div>
        <div class="sidebar-item active" onclick="runSimulation()">‚ñ∂ Run Simulation</div>
        <div class="sidebar-item" style="opacity:0.5">üß± Synthesis (Coming Soon)</div>
    </div>

    <div class="workspace">
        <div class="toolbar">
            <strong>Verilog Pro Playground</strong>
            <button class="run-btn" onclick="runSimulation()">Run Simulation</button>
        </div>

        <div class="editor-area">
            <div class="editor-container">
                <div class="editor-header">TESTBENCH.V</div>
                <div id="tb-editor" class="editor-instance"></div>
            </div>
            <div class="editor-container">
                <div class="editor-header">DESIGN.V</div>
                <div id="design-editor" class="editor-instance"></div>
            </div>
        </div>

        <div id="console">Ready for simulation...</div>
    </div>
</div>

<div id="overlay" onclick="closePopup()"></div>

<div id="popup">
    <button class="run-btn" onclick="closePopup()">Close Waveform</button>

    <div id="wave-toolbar">
        <button onclick="zoomIn()">Ôºã</button>
        <button onclick="zoomOut()">Ôºç</button>
        <button onclick="resetZoom()">Reset</button>
        <button onclick="toggleCursor()">Cursor</button>
        <span id="zoom-level">100%</span>
    </div>

    <div id="waveform-svg-container">
        <div id="wave-cursor"></div>
    </div>
</div>

<script>
let tbEditor, designEditor;

/* ===== MONACO ===== */
require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });
require(['vs/editor/editor.main'], function () {
    const cfg = {
        theme: 'vs-dark',
        language: 'verilog',
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: false }
    };

    tbEditor = monaco.editor.create(document.getElementById('tb-editor'), {
        ...cfg,
        value:
`module full_adder_tb;
  reg a,b,cin;
  wire sum,cout;

  full_adder uut(a,b,cin,sum,cout);

  initial begin
    $dumpfile("dump.vcd");
    $dumpvars(0, full_adder_tb);

    a=0;b=0;cin=0; #10;
    a=0;b=0;cin=1; #10;
    a=0;b=1;cin=0; #10;
    a=0;b=1;cin=1; #10;
    a=1;b=0;cin=0; #10;
    a=1;b=0;cin=1; #10;
    a=1;b=1;cin=0; #10;
    a=1;b=1;cin=1; #10;
    $finish;
  end
endmodule`
    });

    designEditor = monaco.editor.create(document.getElementById('design-editor'), {
        ...cfg,
        value:
`module full_adder(input a,b,cin, output sum,cout);
  assign sum = a ^ b ^ cin;
  assign cout = (a&b)|(b&cin)|(a&cin);
endmodule`
    });
});

/* ===== SIMULATION ===== */
async function runSimulation() {
    const c = document.getElementById("console");
    c.innerText = "Simulating...\n";

    const res = await fetch("https://hdl-backend-a39u.onrender.com/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            design: designEditor.getValue(),
            testbench: tbEditor.getValue()
        })
    });

    const data = await res.json();
    c.innerText += data.log;

    if (data.vcd) renderWaveform(data.vcd);
}

/* ===== WAVEFORM ===== */
let zoom = 1, cursorOn = false;

function renderWaveform(vcd) {
    const lines = vcd.split("\n");
    let sigs = [];

    lines.forEach(l=>{
        if(l.trim().startsWith("$var")){
            const p=l.trim().split(/\s+/);
            sigs.push({id:p[3],name:p[4],wave:""});
        }
    });

    lines.forEach(l=>{
        if(l.startsWith("#")) sigs.forEach(s=>s.wave+=".");
        else sigs.forEach(s=>{
            if(l.endsWith(s.id)){
                s.wave=s.wave.slice(0,-1)+l[0];
            }
        });
    });

    document.getElementById("overlay").style.display="block";
    document.getElementById("popup").style.display="block";

    const cont=document.getElementById("waveform-svg-container");
    cont.innerHTML='<div id="wave-cursor"></div>';

    const sc=document.createElement("script");
    sc.type="WaveDrom";
    sc.text=JSON.stringify({signal:sigs});
    cont.appendChild(sc);

    WaveDrom.ProcessAll();
    applyZoom();
}

/* ===== ZOOM ===== */
function applyZoom(){
    const svg=document.querySelector("#waveform-svg-container svg");
    if(!svg)return;
    svg.style.transformOrigin="0 0";
    svg.style.transform=`scale(${zoom})`;
    document.getElementById("zoom-level").innerText=Math.round(zoom*100)+"%";
}
function zoomIn(){ zoom=Math.min(zoom+0.1,3); applyZoom(); }
function zoomOut(){ zoom=Math.max(zoom-0.1,0.5); applyZoom(); }
function resetZoom(){ zoom=1; applyZoom(); }

/* ===== CURSOR ===== */
function toggleCursor(){
    cursorOn=!cursorOn;
    document.getElementById("wave-cursor").style.display=cursorOn?"block":"none";
}
document.getElementById("waveform-svg-container").addEventListener("mousemove",e=>{
    if(cursorOn) document.getElementById("wave-cursor").style.left=e.offsetX+"px";
});

function closePopup(){
    document.getElementById("overlay").style.display="none";
    document.getElementById("popup").style.display="none";
}
</script>
</body>
</html>
